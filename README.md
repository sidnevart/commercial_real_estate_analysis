# Commercial Real Estate Analysis Platform

## Описание проекта
Платформа для анализа коммерческой недвижимости, которая собирает данные с торговых площадок и CIAN, проводит анализ рыночных цен и выявляет потенциально выгодные предложения.

## Требования

- Python 3.8+
- Google API ключи доступа (для работы с Google Sheets)
- Chromedriver и Chrome (для работы с Selenium)
- 2GIS API ключ (для расчета расстояний)

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/commercial_real_estate.git
   cd commercial_real_estate
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Настройте файл конфигурации:
   ```bash
   cp config.example.yaml config.yaml
   ```
   Отредактируйте `config.yaml` с вашими API ключами и настройками.

4. Создайте файл с учетными данными Google Sheets:
   ```bash
   # Поместите файл с ключами JSON в папку credentials/
   mkdir -p credentials
   # Скопируйте ваш файл service_account.json
   ```

## Запуск программы

1. Основной скрипт:
   ```bash
   python -m parser.main
   ```

2. Только для сбора данных с торгов:
   ```bash
   python -m parser.torgi_async
   ```

3. Только для анализа CIAN:
   ```bash
   python -m parser.cian_minimal
   ```

4. С возобновлением из чекпоинта:
   ```bash
   python -m parser.main --resume
   ```

## Структура проекта

```
commercial_real_estate/
├── core/                  # Общие компоненты
│   ├── config.py          # Конфигурация проекта
│   └── models.py          # Модели данных (Lot, Offer)
├── parser/                # Парсеры и обработчики
│   ├── cian_minimal.py    # Парсер CIAN
│   ├── geo_utils.py       # Утилиты для работы с геоданными
│   ├── google_sheets.py   # Экспорт в Google Sheets
│   ├── gpt_classifier.py  # Классификация объектов с помощью GPT
│   ├── main.py            # Основной скрипт
│   ├── proxy_rotator.py   # Ротатор прокси
│   └── torgi_async.py     # Асинхронный парсер торгов
├── cian_debug_logs/       # Отладочные логи CIAN
├── credentials/           # Учетные данные API
├── README.md              # Документация
├── config.yaml            # Конфигурационный файл
└── requirements.txt       # Зависимости
```

## Структура таблиц Google Sheets

### 1. Таблица `cian_sale` и `cian_rent`
Обе таблицы имеют одинаковую структуру столбцов:

| № | Название столбца | Описание | Тип данных |
|---|-----------------|----------|------------|
| A | Адрес | Адрес объекта | Текст |
| B | Район | Район объекта | Текст |
| C | Площадь | Площадь в квадратных метрах | Число |
| D | Цена за м² | Рассчитывается как Price/Area | Число |
| E | Общая цена | Полная стоимость объекта | Число |
| F | Расстояние | Расстояние до лота в км | Число |
| G | URL | Ссылка на объявление | Текст (URL) |
| H | UUID лота | Идентификатор связанного лота | Текст |

### 2. Таблица `torgi`

| № | Название столбца | Описание | Тип данных |
|---|-----------------|----------|------------|
| A | ID | Идентификатор лота | Текст |
| B | Номер лота | Номер лота в системе торгов | Число |
| C | Название | Название объекта | Текст |
| D | Адрес | Полный адрес объекта | Текст |
| E | Район | Район объекта | Текст |
| F | Категория | Категория объекта | Текст |
| G | Площадь | Площадь в квадратных метрах | Число |
| H | Текущая цена за м² | Текущая цена за квадратный метр | Число |
| I | Рыночная цена за м² | Рыночная цена за квадратный метр | Число |
| J | Историческая стоимость | Предыдущая общая стоимость | Число |
| K | Текущая стоимость | Текущая общая стоимость | Число |
| L | Рыночная стоимость | Рыночная общая стоимость | Число |
| M | Капитализация (сумма) | Разница между рыночной и текущей стоимостью | Число |
| N | Капитализация (%) | Процент потенциальной прибыли | Число (%) |
| O | Ежемесячная разница | Ежемесячный доход | Число |
| P | Годовая доходность | Годовая доходность в процентах | Число (%) |
| Q | Тип продажи | Тип продажи | Текст |
| R | URL аукциона | Ссылка на страницу аукциона | Текст (URL) |
| S | Номер уведомления | Номер официального уведомления | Текст |
| T | Номер лота | Номер лота в системе | Число |
| U | Тип аукциона | Тип проводимого аукциона | Текст |
| V | Тип продажи | Тип продажи | Текст |
| W | Ссылка на закон | Законодательная основа аукциона | Текст |
| X | Начало заявок | Дата и время начала подачи заявок | Дата/время |
| Y | Окончание заявок | Дата и время окончания подачи заявок | Дата/время |
| Z | Начало аукциона | Дата и время начала аукциона | Дата/время |
| AA | Кадастровый номер | Кадастровый номер объекта | Текст |
| AB | Категория недвижимости | Категория недвижимости | Текст |
| AC | Тип собственности | Тип права собственности | Текст |
| AD | Шаг аукциона | Минимальный шаг повышения цены | Число |
| AE | Депозит | Размер требуемого депозита | Число |
| AF | Получатель | Название организации-получателя | Текст |
| AG | ИНН получателя | ИНН получателя платежа | Текст |
| AH | КПП получателя | КПП получателя платежа | Текст |
| AI | Название банка | Название банка-получателя | Текст |
| AJ | БИК банка | БИК банка-получателя | Текст |
| AK | Счет банка | Банковский счет | Текст |
| AL | Корр. счет | Корреспондентский счет | Текст |
| AM | UUID | Уникальный идентификатор | Текст |
| AN | Категория размера | Категория по размеру | Текст |
| AO | Наличие подвала | Есть ли подвал (Да/Нет) | Текст |
| AP | Верхний этаж | Находится ли на верхнем этаже (Да/Нет) | Текст |

## Работа с чекпоинтами

### Сохранение прогресса

Система автоматически сохраняет прогресс обработки через регулярные интервалы:
- Каждые `lot_save_interval` обработанных лотов создается промежуточный чекпоинт
- При возникновении ошибок создается аварийный чекпоинт
- На диске хранятся последние 3 чекпоинта, старые удаляются автоматически

### Возобновление работы

Возобновить работу из последнего чекпоинта можно с помощью флага `--resume`:
```bash
python -m parser.main --resume
```

Система автоматически:
1. Найдет последний доступный чекпоинт
2. Восстановит состояние обработки
3. Продолжит с того места, где остановилась

## Решение частых проблем

### 1. Ошибка при запуске ChromeDriver

**Проблема**: `selenium.common.exceptions.InvalidArgumentException: Message: invalid argument: cannot parse capability`

**Решение**: 
```python
# В файле cian_minimal.py замените строки:
options.add_experimental_option("excludeSwitches", ["enable-automation"])
options.add_experimental_option("useAutomationExtension", False)

# На:
options.add_argument('--disable-blink-features=AutomationControlled')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')
```

### 2. Ошибка API 2GIS

**Проблема**: `Client error '400 Bad Request' for url 'https://routing.api.2gis.com/get_dist_matrix`

**Решение**: Проверьте формат координат. Координаты должны передаваться без пробелов:
```python
# Неправильно:
source_point = f"{source_coords[0]}, {source_coords[1]}"

# Правильно:
source_point = f"{source_coords[0]:.6f},{source_coords[1]:.6f}"
```

### 3. Парсер внезапно останавливается

**Решение**:
- Используйте механизм чекпоинтов для возобновления работы (`--resume`)
- Установите ограничение на количество операций перед перезапуском браузера
- Увеличьте интервалы между запросами в CONFIG

### 4. Проблемы с загрузкой чекпоинта

**Проблема**: `pickle.UnpicklingError: invalid load key`

**Решение**: Возможная несовместимость версий Python или повреждение файла чекпоинта. Удалите старые чекпоинты и начните заново, или используйте флаг `--no-resume`.